name: Github Actions Bazel Test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      # Set up JDK 11 in runtime environment for running the Detect tool (invoked by the
      # detect plugin)
      - name: Set up JDK 11
        uses: actions/setup-java@v2
        with:
          java-version: '11'
          distribution: 'adopt'

      # Set up Python 3.8 & install, cache blackduck-c-cpp
      - name: Setup python
        uses: actions/setup-python@v3
        with:
          python-version: '3.8'
          cache: 'pip'
      - run: pip install blackduck-c-cpp -r requirements.txt

      # Execute test by blackduck-c-cpp
      - name: Test by blackduck-c-cpp
        working-directory: ./cpp-test/src
        env:
          COV_CONFIG: '{"clang++-12": "clangcxx", "clang-12": "clangcc"}'
          BUILD_CMD: 'bazel clean; bazel build --config=clang_config --sandbox_debug //main:hello-world'
          BD_URL: 'https://testing.blackduck.synopsys.com/'
          API_TOKEN: ${{ secrets.BLACKDUCK_TESTSERVER_TOKEN }} 
        run: >
          blackduck-c-cpp
          --cov_configure_args="$COV_CONFIG"
          --build_cmd="$BUILD_CMD"
          --project_name="MK-woven-bd-c-cpp-test"
          --project_version="$BUILD_NUMBER"
          --build_dir="$GITHUB_WORKSPACE/cpp-test/src"
          --bd_url="$BD_URL"
          --api_token="$API_TOKEN"

      # Remove the comment below when want to start a debugging ssh session 
      #  uses: lhotari/action-upterm@v1
      
